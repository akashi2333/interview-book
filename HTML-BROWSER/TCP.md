# TCP

- TCP是面向连接的协议，提供全双工通信。
- TCP使用校验、确认和重传机制来保证可靠传输。
- TCP首部最小有20字节。
- TCP只能是一对一通信。
- TCP面向字节流通信。
- TCP 使用滑动窗口机制来实现流量控制，通过动态改变窗口的大小进行拥塞控制。

## 三次握手

1. 第一次握手：建立连接。客户端发送连接请求报文段，将`SYN`位置为1，`seq`随机的为x；然后，客户端进入`SYN_SEND`状态，等待服务器端的确认。服务器端由`SYN=1`知道，客户端请求建立连接；
2. 第二次握手：服务器端收到`SYN`报文段，需要确认联机信息，设置`ack`为x+1(客户端的`seq+1`)；同时，自己还要发送`SYN`请求信息，将`SYN`位置为1，`seq`再随机为y；此时服务器进入`SYN_RECV`状态；
3. 第三次握手：客户端收到后检查`ack`是否正确。即第一次发送的`seq+1`,以及位码`ack`是否为1，若正确，客户端会再发送`ack`=(服务器的`seq`+1),`ack=1`，服务器收到后确认`seq`值与`ack=1`，则连接建立成功。客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。

![img](https://imgconvert.csdnimg.cn/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTcwNjA1MTEwNDA1NjY2?x-oss-process=image/format,png)

## 四次挥手

1. 第一次挥手：客户端发送一个`FIN`，用来关闭客户端到服务器端的数据传送，客户端进入`FIN_WAIT_1`状态。
2. 第二次挥手：服务器端收到`FIN`后，发送一个`ACK`给客户端，确认序号为收到序号+1（与`SYN`相同，一个`FIN`占用一个序号），服务器端进入`CLOSE_WAIT`状态。
3. 第三次挥手：服务器端发送一个`FIN`，用来关闭服务器端到客户端的数据传送，服务器端进入`LAST_ACK`状态。
4. 第四次挥手：客户端收到`FIN`后，客户端进入`TIME_WAIT`状态，接着发送一个`ACK`给服务器端，确认序号为收到序号+1，服务器端进入`CLOSED`状态，完成四次挥手。

![四次挥手](https://imgconvert.csdnimg.cn/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTcwNjA2MDg0ODUxMjcy?x-oss-process=image/format,png)

## TCP滑动窗口

解决发送方和接收方收发数据速率不一致的问题。滑动窗口相当于接收方的缓存，接收方向发送方通知自己可接受数据的大小，而发送方会根据这个数值发送数据。

发送窗口

- 已经发送并且对端确认（Sent/ACKed）---------------发送窗外 缓冲区外
- 已经发送但未收到确认数据（Sent/UnACKed）----- --发送窗内 缓冲区内
- 允许发送但尚未防的数据（Unsent/Inside）-----------发送窗内 缓冲区内
- 未发送暂不允许（Unsent/Outside）-------------------发送窗外 缓冲区内

接收窗口

“已接收”，“未接收准备接收”，“未接收并未准备接收”。其中“未接收准备接收”称之为接收窗口。

## 与UDP的区别

- UDP无连接，不可靠。
- UDP面向报文。
- UDP可以一对一或者一对多。
- UDP首部只有8字节。
- UDP用于高速传输和对实时性有较高要求的通信（视频、音频等多媒体通信）或广播通信。